function doPost(e) {

  const nickname = (e.parameter.nickname || "").trim().toLowerCase();
  const stage = e.parameter.stage;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(stage);

  if (!sheet) {
    return ContentService.createTextOutput("Sheet not found");
  }

  const kvala = [];
  const race = [];

  for (let i = 1; i <= 5; i++) {
    kvala.push(e.parameter[`квала_${i}`] || "");
  }

  for (let i = 1; i <= 10; i++) {
    race.push(e.parameter[`гонка_${i}`] || "");
  }

  const now = Utilities.formatDate(
    new Date(),
    "Europe/Moscow",
    "dd_MM_yyyy HH:mm"
  );

  const lastRow = sheet.getLastRow();
  let registrationDate = now;

  if (lastRow > 1) {

    const names = sheet.getRange(2, 1, lastRow - 1, 1).getValues();

    for (let i = names.length - 1; i >= 0; i--) {

      const rowIndex = i + 2;
      const currentName = (names[i][0] || "").toString().trim().toLowerCase();

      if (currentName === nickname) {

        // Сохраняем дату регистрации (предпоследний столбец)
        const oldRegDate = sheet
          .getRange(rowIndex, sheet.getLastColumn() - 1)
          .getValue();

        if (oldRegDate) {
          registrationDate = oldRegDate;
        }

        // Удаляем строку
        sheet.deleteRow(rowIndex);
      }
    }
  }

  const newLastRow = sheet.getLastRow();

  const dataRow = [
    nickname,
    "",
    ...kvala,
    "",
    ...race,
    registrationDate,
    now
  ];

  sheet.getRange(newLastRow + 1, 1, 1, dataRow.length).setValues([dataRow]);

  return ContentService.createTextOutput("OK");
}
